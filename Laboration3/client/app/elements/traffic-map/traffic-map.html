<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../elements.html">

<polymer-element name="traffic-map" attributes="messages">
  <template>
    <link rel="stylesheet" href="traffic-map.css">
    <google-map fit fitToMarkers disableDefaultUI on-mousedown="{{closeWindows}}" id="map" styles="{{styles}}">
      <template repeat="{{message in messages}}">
        <google-map-marker latitude="{{message.latitude}}" longitude="{{message.longitude}}">
          <h3>{{message.title}}</h3>
          <div layout horizontal center class="infoline">
            <span>{{message.category | category}}</span>
            |
            <span>{{message.subcategory}}</span>
            |
            <span>
              <time is="relative-time" datetime="{{message.createddate | isoDate}}">
                {{message.createddate | humanTime}}
              </time>
            </span>
          </div>
          <p>{{message.description}}</p>
        </google-map-marker>
      </template>
    </google-map>
    <script src="../../bower_components/time-elements/time-elements.js"></script>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        category: function (value) {
          return ['Vägtrafik', 'Kollektivtrafik', 'Planerad störning', 'Övrigt'][value];
        },
        humanTime: function (value) {
          var date = new Date(+value.slice(6, -7));
          return date.toLocaleString();
        },
        isoDate: function (value) {
          var date = new Date(+value.slice(6, -7));
          return date.toISOString();
        },
        closeWindows: function () {
          [].slice.apply(this.$.map.querySelectorAll('google-map-marker')).forEach(function(marker) {
            marker.info.close();
          });
        },
        showMessage: function (latitude, longitude) {
          this.closeWindows();
          this.$.map.setAttribute('latitude', latitude);
          this.$.map.setAttribute('longitude', longitude);
          var marker = this.$.map.querySelector('google-map-marker[latitude="'+latitude+'"][longitude="'+longitude+'"]');
          marker.info.open(marker.map, marker.marker);
        },
        styles: [
          {
            "featureType": "water",
            "elementType": "geometry.fill",
            "stylers": [
              {
                "color": "#d3d3d3"
              }
            ]
          },
          {
            "featureType": "transit",
            "stylers": [
              {
                "color": "#808080"
              },
              {
                "visibility": "on"
              }
            ]
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry.stroke",
            "stylers": [
              {
                "visibility": "on"
              },
              {
                "color": "#b3b3b3"
              }
            ]
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry.fill",
            "stylers": [
              {
                "color": "#ffffff"
              }
            ]
          },
          {
            "featureType": "road.local",
            "elementType": "geometry.fill",
            "stylers": [
              {
                "visibility": "on"
              },
              {
                "color": "#ffffff"
              },
              {
                "weight": 1.8
              }
            ]
          },
          {
            "featureType": "road.local",
            "elementType": "geometry.stroke",
            "stylers": [
              {
                "color": "#d7d7d7"
              }
            ]
          },
          {
            "featureType": "poi",
            "elementType": "geometry.fill",
            "stylers": [
              {
                "visibility": "on"
              },
              {
                "color": "#ebebeb"
              }
            ]
          },
          {
            "featureType": "administrative",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#a7a7a7"
              }
            ]
          },
          {
            "featureType": "road.arterial",
            "elementType": "geometry.fill",
            "stylers": [
              {
                "color": "#ffffff"
              }
            ]
          },
          {
            "featureType": "road.arterial",
            "elementType": "geometry.fill",
            "stylers": [
              {
                "color": "#ffffff"
              }
            ]
          },
          {
            "featureType": "landscape",
            "elementType": "geometry.fill",
            "stylers": [
              {
                "visibility": "on"
              },
              {
                "color": "#efefef"
              }
            ]
          },
          {
            "featureType": "road",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#696969"
              }
            ]
          },
          {
            "featureType": "administrative",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "visibility": "on"
              },
              {
                "color": "#737373"
              }
            ]
          },
          {
            "featureType": "poi",
            "elementType": "labels.icon",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "poi",
            "elementType": "labels",
            "stylers": [
              {
                "visibility": "on"
              }
            ]
          },
          {
            "featureType": "road.arterial",
            "elementType": "geometry.stroke",
            "stylers": [
              {
                "color": "#d6d6d6"
              }
            ]
          },
          {
            "featureType": "road",
            "elementType": "labels.icon",
            "stylers": [
              {
                "visibility": "on"
              }
            ]
          },
          {},
          {
            "featureType": "poi",
            "elementType": "geometry.fill",
            "stylers": [
              {
                "color": "#dadada"
              }
            ]
          }
        ],
      });

    })();
  </script>
</polymer-element>
